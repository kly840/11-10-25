<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex" />
  <title>Mini-quiz â€” 11Â·10Â·25</title>
  <link rel="stylesheet" href="./assets/styles.css" />
  <style>
    .field{margin:10px 0}
    .lock{background:#201f2a;border:1px dashed #3b3a46;border-radius:14px;padding:14px;margin-top:12px}
    input,button{padding:8px 10px;border-radius:6px;border:1px solid #333;background:#14141a;color:#fff;width:100%}
    button{cursor:pointer;border:0;background:#111}
    button:hover{background:#333}
    label{font-size:14px;color:#aab1c6}
  </style>
</head>
<body>
  <header>
    <h1>Mini-quiz ğŸ¯</h1>
    <p class="small">Tráº£ lá»i Ä‘Ãºng Ä‘á»ƒ má»Ÿ thÆ° bÃ­ máº­t.</p>
  </header>

  <main style="max-width:720px">
    <form id="quiz" class="lock">
      <div class="field">
        <label><strong>1)</strong> Our first call ended at what time?</label>
        <input name="q1" placeholder="e.g., 02:13 AM" required />
      </div>
      <div class="field">
        <label><strong>2)</strong> Where did we see the broken umbrella?</label>
        <input name="q2" placeholder="place" required />
      </div>
      <div class="field">
        <label><strong>3)</strong> The safe-word on our first trip?</label>
        <input name="q3" placeholder="word" required />
      </div>
      <button type="submit" class="btn" style="width:auto">Check</button>
      <p id="msg" class="small"></p>
    </form>

    <nav class="mini" style="margin-top:16px;display:flex;gap:16px;flex-wrap:wrap">
      <a class="btn" href="./timeline.html">Back to timeline</a>
      <a class="btn" href="./index.html">Home</a>
    </nav>
  </main>

  <script>
    // ==== CONFIG (chá»‰nh táº¡i Ä‘Ã¢y) ====
    // CÃ¡c Ä‘Ã¡p Ã¡n Ä‘Ãºng (cho phÃ©p nhiá»u biáº¿n thá»ƒ). Viáº¿t thÆ°á»ng khÃ´ng dáº¥u/Ä‘á»‹nh dáº¡ng khi so sÃ¡nh.
    const ANSWERS = {
      q1: ["2:13 am","02:13 am","0213"],     // vÃ­ dá»¥
      q2: ["bus stop","at the bus stop"],    // vÃ­ dá»¥
      q3: ["pineapple"]                      // vÃ­ dá»¥
    };
    // Muá»‘i bÃ­ máº­t (salt): Ä‘á»•i chuá»—i nÃ y thÃ nh cÃ¡i chá»‰ báº¡n biáº¿t
    const SALT = "change_this_to_your_secret_salt_11-10-25";
    // ÄÆ°á»ng dáº«n thÆ°
    const LETTER_URL = "./letters/letter-1.html";

    // Chuáº©n hoÃ¡ input Ä‘á»ƒ so sÃ¡nh (lowercase, bá» dáº¥u cÃ¢u/spaces cÆ¡ báº£n)
    function normalize(s){
      return (s||"").toString().trim().toLowerCase()
        .replace(/[^\p{L}\p{N}]+/gu,"") // bá» khoáº£ng tráº¯ng & kÃ½ tá»± láº¡
    }

    // Kiá»ƒm tra Ä‘Ãºng háº¿t
    function isAllCorrect(formData){
      return Object.keys(ANSWERS).every(k => {
        const a = normalize(formData.get(k));
        return (ANSWERS[k]||[]).some(ok => normalize(ok) === a);
      });
    }

    // Táº¡o token SHA-256 (Web Crypto API)
    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    // Táº¡o token tá»« Ä‘Ã¡p Ã¡n Ä‘Ãºng + SALT
    async function buildToken(formData){
      // GhÃ©p chuá»—i theo thá»© tá»± key Ä‘á»ƒ nháº¥t quÃ¡n
      const keyOrder = Object.keys(ANSWERS);
      const joined = keyOrder.map(k => normalize(formData.get(k))).join("|") + "|" + SALT;
      return sha256Hex(joined);
    }

    const form = document.getElementById('quiz');
    const msg  = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(form);

      if (!isAllCorrect(data)) {
        msg.textContent = "Hmm not yet â€” try again ğŸ˜‰";
        return;
      }
      msg.textContent = "Correct! Unlocking letterâ€¦ ğŸ’–";

      // táº¡o token & chuyá»ƒn sang trang thÆ° kÃ¨m ?t=TOKEN
      const token = await buildToken(data);
      const url = new URL(LETTER_URL, location.href);
      url.searchParams.set("t", token);
      location.href = url.toString();
    });
  </script>
</body>
</html>
