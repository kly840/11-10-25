<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex"/>
  <title>Unlock My Letter</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css"/>
</head>
<body>
  <header>
    <h1>Heyyyy! Before you read my letterâ€¦</h1>
    <p class="small">you gotta answer a mini-quiz to unlock it ðŸ’¡</p>
  </header>

  <main class="two-col">
    <!-- Col 1: Quiz -->
    <section class="quizbox">
      <form id="quiz">
        <label><strong>1)</strong> Our first call ended at what time?</label>
        <input type="text" name="q1" placeholder="e.g., 02:13 AM" required>

        <label><strong>2)</strong> Where did we see the broken umbrella?</label>
        <input type="text" name="q2" placeholder="place" required>

        <label><strong>3)</strong> The safe-word on our first trip?</label>
        <input type="text" name="q3" placeholder="word" required>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="btn" type="submit">unlock my letter ^^</button>
          <a class="btn ghost" href="./index.html">Back Home</a>
          <a class="btn ghost" href="./audio.html">Audio</a>
          <a class="btn ghost" href="./timeline.html">Memory</a>
        </div>
        <p id="msg" class="small"></p>
      </form>
    </section>

    <!-- Col 2: Image (img-ref from brief) -->
    <aside>
      <img src="./assets/hello_nhan_khungf_letter.png" alt="" style="border-radius:16px; box-shadow:var(--shadow); width:100%; object-fit:cover">
    </aside>
  </main>

  <footer class="small">heart â€¢ hold your close</footer>

  <script>
    // Answers + salt (same as letter page)
    const ANSWERS = { q1:["2:13 am","02:13 am","0213"], q2:["bus stop","at the bus stop"], q3:["pineapple"] };
    const SALT = "kly840";
    const LETTER_URL = "./letters/letter-1.html";

    function normalize(s){ return (s||"").toString().trim().toLowerCase().replace(/[^\p{L}\p{N}]+/gu,""); }
    async function sha256Hex(str){ const buf=await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str)); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join(""); }
    function isAllCorrect(fd){ return Object.keys(ANSWERS).every(k=>{const a=normalize(fd.get(k)); return (ANSWERS[k]||[]).some(ok=>normalize(ok)===a);}); }
    async function buildCanonicalToken(){ const joined=Object.keys(ANSWERS).map(k=>normalize(ANSWERS[k][0])).join("|")+"|"+SALT; return sha256Hex(joined); }

    // tiny confetti
    function confetti(){ for(let i=0;i<80;i++){ const s=document.createElement('span'); s.className='confetti';
      s.style.left=Math.random()*100+'vw'; s.style.background=`hsl(${Math.random()*360}deg 90% 60%)`;
      s.style.animationDuration=(1.2+Math.random()*0.9)+'s'; s.style.width=(6+Math.random()*6)+'px'; s.style.height=(10+Math.random()*10)+'px';
      document.body.appendChild(s); setTimeout(()=>s.remove(), 2000);
    }}

    const form=document.getElementById('quiz'), msg=document.getElementById('msg');
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const data=new FormData(form);
      if(!isAllCorrect(data)){ msg.textContent="Hmm not yet â€” try again ðŸ˜‰"; return; }
      msg.textContent="Correct! Unlocking letterâ€¦ ðŸ’–";
      confetti();
      const token=await buildCanonicalToken();
      const url=new URL(LETTER_URL, location.href); url.searchParams.set("t", token);
      setTimeout(()=>{ location.href = url.toString(); }, 900);
    });
  </script>
</body>
</html>
