<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex" />
  <title>Mini-quiz — 11·10·25</title>
  <link rel="stylesheet" href="./assets/styles.css" />
  <style>
    .field{margin:10px 0}
    .lock{background:#201f2a;border:1px dashed #3b3a46;border-radius:14px;padding:14px;margin-top:12px}
    input,button{padding:8px 10px;border-radius:6px;border:1px solid #333;background:#14141a;color:#fff;width:100%}
    button{cursor:pointer;border:0;background:#111}
    button:hover{background:#333}
    label{font-size:14px;color:#aab1c6}
  </style>
</head>
<body>
  <header>
    <h1>Mini-quiz 🎯</h1>
    <p class="small">Trả lời đúng để mở thư bí mật.</p>
  </header>

  <main style="max-width:720px">
    <form id="quiz" class="lock">
      <div class="field">
        <label><strong>1)</strong> Our first call ended at what time?</label>
        <input name="q1" placeholder="e.g., 02:13 AM" required />
      </div>
      <div class="field">
        <label><strong>2)</strong> Where did we see the broken umbrella?</label>
        <input name="q2" placeholder="place" required />
      </div>
      <div class="field">
        <label><strong>3)</strong> The safe-word on our first trip?</label>
        <input name="q3" placeholder="word" required />
      </div>
      <button type="submit" class="btn" style="width:auto">Check</button>
      <p id="msg" class="small"></p>
    </form>

    <nav class="mini" style="margin-top:16px;display:flex;gap:16px;flex-wrap:wrap">
      <a class="btn" href="./timeline.html">Back to timeline</a>
      <a class="btn" href="./index.html">Home</a>
    </nav>
  </main>

  <script>
    // ==== CONFIG ====
    const ANSWERS = {
      q1: ["2:13 am","02:13 am","0213"],
      q2: ["bus stop","at the bus stop"],
      q3: ["pineapple"]
    };
    const SALT = "kly840";
    const LETTER_URL = "./letters/letter-1.html";

    function normalize(s){
      return (s||"").toString().trim().toLowerCase()
        .replace(/[^\p{L}\p{N}]+/gu,"");
    }
    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    function isAllCorrect(formData){
      return Object.keys(ANSWERS).every(k => {
        const a = normalize(formData.get(k));
        return (ANSWERS[k]||[]).some(ok => normalize(ok) === a);
      });
    }

    // ✅ build canonical token
    async function buildCanonicalToken(){
      const keyOrder = Object.keys(ANSWERS);
      const joined = keyOrder.map(k => normalize(ANSWERS[k][0])).join("|") + "|" + SALT;
      return sha256Hex(joined);
    }

    const form = document.getElementById('quiz');
    const msg  = document.getElementById('msg');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = new FormData(form);
      if (!isAllCorrect(data)) { msg.textContent = "Hmm not yet — try again 😉"; return; }

      msg.textContent = "Correct! Unlocking letter… 💖";
      const token = await buildCanonicalToken();
      const url = new URL(LETTER_URL, location.href);
      url.searchParams.set("t", token);
      location.href = url.toString();
    });
  </script>
</body>
</html>
