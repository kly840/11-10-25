<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex"/>
  <title>Our Memory</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* logo top-left + hover (y nh∆∞ index) */
    .logo-top{ position:absolute; top:18px; left:18px; display:inline-block; }
    .logo-top img{
      height:48px; width:auto; opacity:.95;
      transition:transform .12s ease, filter .12s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.08));
    }
    .logo-top:hover img{ transform:scale(1.06); filter: drop-shadow(0 6px 14px rgba(0,0,0,.16)); }

    /* layout ƒë·ªÉ nav d√≠nh cu·ªëi trang khi n·ªôi dung √≠t */
    .page{ display:flex; flex-direction:column; min-height:75dvh; }

    /* callout form: ƒë·∫≠m + g·∫•p ƒë√¥i k√≠ch th∆∞·ªõc th∆∞·ªùng (gi·ªØ nh∆∞ c≈©) */
    .callout{
      font-weight:800;
      font-size:clamp(18px, 3.2vw, 26px);
      margin:8px 0 10px;
    }

    /* gallery grid (nhi·ªÅu item v·∫´n ok) */
    .gallery{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap:16px;
      align-items:start;
    }

    /* Polaroid card (gi·ªØ style g·ªëc t·ª´ styles.css), ch·ªâ th√™m media vu√¥ng & why nh·ªè h∆°n */
    .polaroid{ position:relative; }
    .polaroid .media-1x1{
      aspect-ratio: 1 / 1;        /* lu√¥n vu√¥ng */
      width: 100%;
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,.04); /* n·ªÅn nh·∫π khi ch·ªù ·∫£nh/video */
    }
    .polaroid .media-1x1 img{
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .polaroid .media-1x1 iframe{
      width:100%; height:100%; border:0; display:block;
    }

    .polaroid .caption .why{ font-size:.9em; line-height:1.45; } /* why nh·ªè h∆°n m·ªôt ch√∫t */
    .polaroid .when{ opacity:.8; font-size:.9em; }

    /* nav cu·ªëi trang */
    .spacer{ flex:1 1 auto; }
    .bottom-nav{
      display:flex; gap:12px; flex-wrap:wrap; justify-content:center;
      margin-top:12px; margin-bottom:4px;
    }

    /* n√∫t ‚Äúload more‚Äù fallback n·∫øu browser kh√¥ng h·ªó tr·ª£ IntersectionObserver */
    .load-more-wrap{ text-align:center; margin:10px 0 0 }
    .load-more{ display:inline-block; padding:8px 14px; border-radius:20px; font-weight:700; border:0; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Logo -->
  <a href="./index.html" class="logo-top" aria-label="Home">
    <img src="./assets/heart_logo.png" alt="logo">
  </a>

  <header>
    <h1>our memories together &gt;&lt;</h1>
    <p class="callout">
      You can add yours via this form ‚Üí
      <a href="PASTE_YOUR_GOOGLE_FORM_LINK" target="_blank" rel="noopener">Here</a>
    </p>
  </header>

  <main class="page">
    <div id="status"></div>

    <!-- gallery -->
    <section id="list" class="gallery" aria-live="polite"></section>

    <!-- sentinel cho lazy render -->
    <div id="sentinel"></div>
    <div class="load-more-wrap" id="fallbackLoadMore" style="display:none;">
      <button class="load-more btn" id="btnLoadMore">Load more</button>
    </div>

    <div class="spacer"></div>

    <!-- bottom nav -->
    <nav class="bottom-nav">
      <a class="btn" href="./index.html">Back Home</a>
      <a class="btn" href="./quiz.html">My letter</a>
      <a class="btn" href="./audio.html">Audio</a>
    </nav>
  </main>

  <footer class="small" style="text-align:center">from kly ‚ô°</footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // CSV ƒë√£ publish
      const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQSQN4PFm-uNK4cj4ZDjz8K5xxXE6SYGw-sr5lZ0kaAJGHFhd4jcfjuJ_-wBnF96FhbvTThDQz7iZBU/pub?gid=453699801&single=true&output=csv";

      const listEl   = document.getElementById('list');
      const statusEl = document.getElementById('status');
      const sentinel = document.getElementById('sentinel');
      const btnMore  = document.getElementById('btnLoadMore');
      const fallbackBox = document.getElementById('fallbackLoadMore');

      const PAGE_SIZE = 12;
      let rows = [], page = 0, io = null;

      /* -------- Helpers -------- */

      // Chu·∫©n h√≥a type = "Video" / "Photo" (fallback n·∫øu c·ªôt Type thi·∫øu)
      function detectType(url, typeCell) {
        const t = (typeCell || "").toString().trim().toLowerCase();
        if (t === "video" || t === "photo") return t;
        const u = (url || "").toString().trim().toLowerCase();
        if (/\/preview(\?|$)/.test(u)) return "video";
        if (/\.(mp4|mov|m4v|webm|avi|mkv)(\?|$)/.test(u)) return "video";
        return "photo";
      }

      // Render media vu√¥ng 1:1 (img ho·∫∑c iframe)
      function renderMedia(url, type, altText){
        const u = (url || "").trim();
        if (type === "video") {
          // N·∫øu user d√°n link /view, ƒë·ªïi sang /preview
          const m = u.match(/\/file\/d\/([^/]+)\/view/);
          const src = m ? `https://drive.google.com/file/d/${m[1]}/preview` : u;
          return `
            <div class="media-1x1">
              <iframe src="${src}" allow="autoplay; encrypted-media" allowfullscreen loading="lazy" referrerpolicy="no-referrer"></iframe>
            </div>`;
        }
        // Photo (ƒë√£ l√† thumbnail/direct). N·∫øu l√† link Drive /view?id=..., b·∫°n c√≥ th·ªÉ t·ª± convert ·ªü Sheet.
        return `
          <div class="media-1x1">
            <img loading="lazy" src="${u}" alt="${altText}">
          </div>`;
      }

      function cardHTML(r, rot){
        const when   = (r["When"] || "").toString().trim();
        const title  = (r["Title"] || "").toString().trim();
        const why    = (r["Why is this memorable to u?"] || "").toString().trim();
        const url    = (r["Photo URL"] || "").toString().trim();
        const type   = detectType(url, r["Type"]);  // ∆∞u ti√™n c·ªôt Type n·∫øu c√≥
        const media  = url ? renderMedia(url, type, title || "memory") : "";

        return `
          <article class="polaroid" style="--rot:${rot}deg">
            ${media}
            <div class="caption">
              <div class="title">${title || "(untitled)"}</div>
              ${when ? `<div class="when">${when}</div>` : ``}
              ${why  ? `<p class="why">${why}</p>` : ``}
            </div>
          </article>
        `;
      }

      function renderNext(){
        const start = page * PAGE_SIZE;
        const slice = rows.slice(start, start + PAGE_SIZE);
        if (!slice.length) return false;
        const html = slice.map(r => cardHTML(r, (Math.random()*4-2).toFixed(2))).join("");
        listEl.insertAdjacentHTML('beforeend', html);
        page++;
        return true;
      }

      function setupInfiniteScroll(){
        if ('IntersectionObserver' in window) {
          io = new IntersectionObserver(entries => {
            entries.forEach(e => {
              if (e.isIntersecting) {
                const ok = renderNext();
                if (!ok) io.disconnect();
              }
            });
          }, { rootMargin: '200px 0px' });
          io.observe(sentinel);
        } else {
          // Fallback n√∫t "Load more"
          fallbackBox.style.display = 'block';
          btnMore.addEventListener('click', () => {
            const ok = renderNext();
            if (!ok) btnMore.disabled = true;
          });
        }
      }

      /* -------- Fetch CSV -------- */
      fetch(CSV_URL, { cache: "no-store" })
        .then(r => r.text())
        .then(text => {
          const parsed = Papa.parse(text, { header: true });
          rows = (parsed.data || []).filter(r => r && r["Title"] && r["Title"].toString().trim());
          // Sort theo Timestamp m·ªõi ‚Üí c≈© (n·∫øu c√≥)
          rows.sort((a,b) => new Date(b["Timestamp"] || 0) - new Date(a["Timestamp"] || 0));

          if (!rows.length) {
            statusEl.innerHTML = `<div class="empty">No memories yet üíå</div>`;
            return;
          }

          // Render trang ƒë·∫ßu
          renderNext();
          // B·∫≠t infinite scroll
          setupInfiniteScroll();
        })
        .catch(err => {
          console.error(err);
          statusEl.innerHTML = `<div class="error">Could not load memories üò¢</div>`;
        });
    });
  </script>
</body>
</html>