<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="robots" content="noindex"/>
  <title>Our Memory</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* Logo top-left gi·ªëng index */
    .logo-top{ position:absolute; top:18px; left:18px; display:inline-block; }
    .logo-top img{
      height:48px; width:auto; opacity:.95;
      transition:transform .12s ease, filter .12s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.08));
    }
    .logo-top:hover img{ transform:scale(1.06); filter: drop-shadow(0 6px 14px rgba(0,0,0,.16)); }

    /* Trang ch√≠nh: ƒë·ªÉ bottom-nav d√≠nh g·∫ßn footer khi n·ªôi dung √≠t */
    .page{ display:flex; flex-direction:column; min-height:75dvh; }

    /* Callout to form: to/ƒë·∫≠m (gi·ªØ m√†u t·ª´ styles.css) */
    .callout{
      font-weight:800;
      font-size:clamp(18px,3.2vw,26px);
      margin:8px 0 10px;
    }

    /* Gallery grid: t·ª± chia c·ªôt khi nhi·ªÅu items */
    .gallery{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:14px;
      padding:8px 12px;
    }

    /* Polaroid card (kh√¥ng ƒë·ªïi m√†u, ch·ªâ layout) */
    .polaroid{
      border-radius:16px;
      padding:10px;
      box-shadow:var(--shadow, 0 8px 22px rgba(0,0,0,.08));
      transform: rotate(var(--rot, 0deg));
      background: var(--paper, #fff);
    }

    /* Media square 1:1 cho ·∫£nh & video */
    .media-square{
      position:relative;
      width:100%;
      aspect-ratio: 1 / 1;   /* CHU·∫®N 1:1 */
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,.03);
      margin-bottom:8px;
    }
    /* ·∫¢nh cover 1:1 */
    .media-square img.cover{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover; object-position:center;
      display:block; border:0;
    }
    /* Video Drive /preview: crop ƒë·ªÉ ‚Äúcover‚Äù khung vu√¥ng */
    .media-square iframe.video-iframe{
      position:absolute; inset:0;
      /* Gi·∫£ ƒë·ªãnh n·ªôi dung 16:9 -> ƒë·ªÉ COVER khung vu√¥ng, m·ªü r·ªông ngang ~177.78% */
      width:177.78%; height:100%;
      left:-38.89%; top:0;
      border:0;
    }

    /* Caption */
    .caption .title{ font-weight:800; line-height:1.3; }
    .caption .when{ font-size:.9em; opacity:.85; margin-top:2px; }
    /* Nh·ªè h∆°n m·ªôt ch√∫t cho ph·∫ßn ‚ÄúWhy is this memorable to u?‚Äù */
    .caption p{ font-size:.9em; line-height:1.5; margin-top:6px; }

    /* Bottom nav */
    .spacer{ flex:1 1 auto; }
    .bottom-nav{
      display:flex; gap:12px; flex-wrap:wrap; justify-content:center;
      margin-top:12px; margin-bottom:4px;
    }
  </style>
</head>
<body>
  <!-- Logo -->
  <a href="./index.html" class="logo-top" aria-label="Home">
    <img src="./assets/heart_logo.png" alt="logo">
  </a>

  <header>
    <h1>our memories together &gt;&lt;</h1>
    <p class="callout">
      You can add yours via this form ‚Üí
      <a href="https://forms.gle/TfrXZ32u5oUAL9T98" target="_blank" rel="noopener">Here</a>
    </p>
  </header>

  <main class="page">
    <div id="status"></div>

    <!-- Gallery -->
    <section id="list" class="gallery" aria-live="polite"></section>

    <div class="spacer"></div>

    <!-- Bottom nav gi·ªëng index/timeline -->
    <nav class="bottom-nav">
      <a class="btn" href="./index.html">Back Home</a>
      <a class="btn" href="./quiz.html">My letter</a>
      <a class="btn" href="./audio.html">Audio</a>
    </nav>
  </main>

  <footer class="small" style="text-align:center">from kly ‚ô°</footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // CSV ƒë√£ publish c·ªßa b·∫°n
      const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQSQN4PFm-uNK4cj4ZDjz8K5xxXE6SYGw-sr5lZ0kaAJGHFhd4jcfjuJ_-wBnF96FhbvTThDQz7iZBU/pub?gid=453699801&single=true&output=csv";

      const listEl  = document.getElementById('list');
      const statusEl= document.getElementById('status');

      // Render helpers
      function toDirectImageURL(u){
        if(!u) return "";
        const m = u.match(/drive\.google\.com\/file\/d\/([^/]+)/) || u.match(/[?&]id=([^&]+)/);
        // N·∫øu l√† link Drive ·∫£nh ch∆∞a chuy·ªÉn -> d√πng thumbnail id=... (·ªïn ƒë·ªãnh cho ·∫£nh)
        return m ? `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1200` : u;
      }

      // type: "Photo" ho·∫∑c "Video"
      function renderMedia(url, type){
        const raw = (url || "").trim();
        const kind = (type || "").trim().toLowerCase();

        if (kind === "video"){
          // B·∫£o ƒë·∫£m l√† /preview (n·∫øu ng∆∞·ªùi d√πng l·ª° d√°n /view)
          let src = raw;
          const mv = raw.match(/\/file\/d\/([^/]+)\/view/);
          if (mv) src = `https://drive.google.com/file/d/${mv[1]}/preview`;
          return `
            <div class="media-square">
              <iframe class="video-iframe" src="${src}" allow="autoplay; encrypted-media" allowfullscreen loading="lazy" referrerpolicy="no-referrer"></iframe>
            </div>
          `;
        }

        // Photo (m·∫∑c ƒë·ªãnh)
        const imgSrc = toDirectImageURL(raw);
        return `
          <div class="media-square">
            <img class="cover" src="${imgSrc}" alt="">
          </div>
        `;
      }

      function cardHTML(r, rot){
        const when  = (r["When"] || "").toString().trim();
        const title = (r["Title"] || "").toString().trim();
        const why   = (r["Why is this memorable to u?"] || "").toString().trim();
        const type  = (r["Type"] || "").toString().trim();           // "Photo" | "Video" (t·ª´ Form)
        const url   = (r["Photo URL"] || "").toString().trim();      // ƒë√£ l√† thumbnail/preview theo c√¥ng th·ª©c Sheet
        const media = renderMedia(url, type);

        return `
          <article class="polaroid" style="--rot:${rot}deg">
            ${media}
            <div class="caption">
              <div class="title">${title || "(untitled)"}</div>
              ${when ? `<div class="when">${when}</div>` : ``}
              ${why ? `<p>${why}</p>` : ``}
            </div>
          </article>
        `;
      }

      // T·ªëi ∆∞u: t·∫£i t·ª´ng ‚Äúpage‚Äù ƒë·ªÉ ƒë·ª° gi·∫≠t n·∫øu qu√° nhi·ªÅu ·∫£nh
      const PAGE_SIZE = 12;
      let rows = [], page = 0;

      function renderNext(){
        const start = page * PAGE_SIZE, slice = rows.slice(start, start + PAGE_SIZE);
        if (!slice.length) return;
        const html = slice.map(r => cardHTML(r, (Math.random()*4 - 2).toFixed(2))).join("");
        listEl.insertAdjacentHTML('beforeend', html);
        page++;
      }

      fetch(CSV_URL, { cache: "no-store" })
        .then(r => r.text())
        .then(text => {
          const parsed = Papa.parse(text, { header: true });
          rows = (parsed.data || []).filter(r => r && r["Title"] && r["Title"].trim());
          // Sort theo Timestamp m·ªõi nh·∫•t tr∆∞·ªõc
          rows.sort((a,b) => new Date(b["Timestamp"]||0) - new Date(a["Timestamp"]||0));
          if (!rows.length){
            statusEl.innerHTML = `<div class="empty">No memories yet üíå</div>`;
            return;
          }
          // Render to√†n b·ªô (chia l√¥)
          while (page * PAGE_SIZE < rows.length) renderNext();
        })
        .catch(err => {
          console.error(err);
          statusEl.innerHTML = `<div class="error">Could not load memories üò¢</div>`;
        });
    });
  </script>
</body>
</html>